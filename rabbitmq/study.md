# rabbitmq

## å®‰è£…

1. å®‰è£… Erlang çš„æ—¶å€™ï¼Œä¸€å®šè¦é€‰æ‹© æœ€ä¸Šé¢çš„é‚£ä¸ªé€‰é¡¹æ’ä»¶ã€‚ç”¨äºæµè§ˆå™¨æ˜¾ç¤ºæ§åˆ¶ç•Œé¢
2. å®‰è£…çš„ç›®å½•è·¯å¾„ä¸è¦å­˜åœ¨ç©ºæ ¼

## å¯åŠ¨

1. è¿›å…¥rabbirmqçš„å®‰è£…ç›®å½• `/d/software/rabbitmq/rabbitmq_server-3.7.7/sbin`
2. å¯åŠ¨ `./rabbitmq-server.bat install`
3. å¯ç”¨ç®¡ç†æ’ä»¶ `./rabbitmq-plugins.bat enable rabbitmq_management`
4. æµè§ˆå™¨ç™»é™† `http://localhost:15672` + `guest as username` -- `guest as password`

å…¶ä»–ä¸€äº›åŸºæœ¬æ“ä½œ

```js
1. å¯åŠ¨

rabbitmq-server &

2. é˜Ÿåˆ—é‡ç½®ï¼ˆæ¸…ç©ºé˜Ÿåˆ—ã€ç”¨æˆ·ç­‰ï¼‰
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl stop

3. å…³é—­
rabbitmqctl stop

4. åˆ—ä¸¾æ‰€æœ‰ç”¨æˆ·
rabbitmqctl list_users

5. åˆ—ä¸¾æ‰€æœ‰é˜Ÿåˆ—
rabbitmqctl list_queues
```

* [é‡è¦çš„å‚è€ƒ](https://www.cnblogs.com/kaituorensheng/p/4985767.html)

## æ¦‚å¿µ

AMQPåè®®æ˜¯ä¸€ä¸ªé«˜çº§æŠ½è±¡å±‚æ¶ˆæ¯é€šä¿¡åè®®ï¼ŒRabbitMQæ˜¯AMQPåè®®çš„å®ç°

### ä¸»è¦ç»„ä»¶

1. serverï¼ˆbrokerï¼‰ï¼šå³æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨å®ä½“ã€‚æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥ï¼Œå®ç°AMQPæ¶ˆæ¯é˜Ÿåˆ—å’Œè·¯ç”±åŠŸèƒ½çš„è¿›ç¨‹
2. Virtual Hostï¼šä¸€ä¸ªè™šæ‹Ÿæ¦‚å¿µï¼Œç±»ä¼¼äºæƒé™æ§åˆ¶ç»„ï¼Œä¸€ä¸ªvirtual host é‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ª Exchange å’Œ Queue
3. Exchangeï¼šæ¶ˆæ¯äº¤æ¢æœºï¼Œå®ƒæŒ‡å®šæ¶ˆæ¯æŒ‰ä»€ä¹ˆè§„åˆ™ï¼Œè·¯ç”±åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚æ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®Bindingè§„åˆ™å°†æ¶ˆæ¯è·¯ç”±ç»™æœåŠ¡å™¨ä¸­çš„é˜Ÿåˆ—ã€‚ExchangeTypeå†³å®šExchangeè·¯ç”±æ¶ˆæ¯çš„è¡Œä¸º
4. Message Queueï¼šæ¶ˆæ¯é˜Ÿåˆ—è½½ä½“ï¼Œç”¨äºå­˜å‚¨è¿˜æœªè¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯
5. Message: ç”±Headerå’ŒBodyç»„æˆï¼ŒHeaderæ˜¯ç”±ç”Ÿäº§è€…æ·»åŠ çš„å„ç§å±æ€§çš„é›†åˆï¼ŒåŒ…æ‹¬Messageæ˜¯å¦è¢«æŒä¹…åŒ–ã€ç”±å“ªä¸ªMessage Queueæ¥å—ã€ä¼˜å…ˆçº§æ˜¯å¤šå°‘ç­‰ã€‚è€ŒBodyæ˜¯çœŸæ­£éœ€è¦ä¼ è¾“çš„APPæ•°æ®ã€‚
6. Bindingï¼š Binding è¿ç³»äº† Exchagne å’Œ Message Queueã€‚exchange åœ¨ä¸å¤šä¸ªMessage Queue å‘ç”Ÿbingingåä¼šç”Ÿæˆä¸€å¼ è·¯ç”±è¡¨ï¼Œè·¯ç”±è¡¨ä¸­å­˜å‚¨ç€Message Queueæ‰€éœ€ä¿¡æ¯çš„é™åˆ¶æ¡ä»¶ -- Binding Key
    å½“ exchange æ”¶åˆ° messageæ—¶ä¼šè§£æå…¶headerå¾—åˆ° Routing keyï¼Œexchangeæ ¹æ®Routing Key ä¸ Exchange Type å°†message è·¯ç”±åˆ° Message Queueã€‚
7. Connection:è¿æ¥ï¼Œå¯¹äºRabbitMQè€Œè¨€ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’ŒBrokerä¹‹é—´çš„TCPè¿æ¥ã€‚
8. Channel:ä¿¡é“ï¼Œä»…ä»…åˆ›å»ºäº†å®¢æˆ·ç«¯åˆ°Brokerä¹‹é—´çš„è¿æ¥åï¼Œå®¢æˆ·ç«¯è¿˜æ˜¯ä¸èƒ½å‘é€æ¶ˆæ¯çš„ã€‚éœ€è¦ä¸ºæ¯ä¸€ä¸ªConnectionåˆ›å»ºChannelï¼ŒAMQPåè®®è§„å®šåªæœ‰é€šè¿‡Channelæ‰èƒ½æ‰§è¡ŒAMQPçš„å‘½ä»¤ã€‚ä¸€ä¸ªConnectionå¯ä»¥åŒ…å«å¤šä¸ªChannelã€‚ä¹‹æ‰€ä»¥éœ€è¦Channelï¼Œæ˜¯å› ä¸ºTCPè¿æ¥çš„å»ºç«‹å’Œé‡Šæ”¾éƒ½æ˜¯ååˆ†æ˜‚è´µçš„ï¼Œå¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½éœ€è¦ä¸Brokeräº¤äº’ï¼Œå¦‚æœæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œæš‚ä¸”ä¸è€ƒè™‘TCPè¿æ¥æ˜¯å¦æµªè´¹ï¼Œå°±ç®—æ“ä½œç³»ç»Ÿä¹Ÿæ— æ³•æ‰¿å—æ¯ç§’å»ºç«‹å¦‚æ­¤å¤šçš„TCPè¿æ¥ã€‚RabbitMQå»ºè®®å®¢æˆ·ç«¯çº¿ç¨‹ä¹‹é—´ä¸è¦å…±ç”¨Channelï¼Œè‡³å°‘è¦ä¿è¯å…±ç”¨Channelçš„çº¿ç¨‹å‘é€æ¶ˆæ¯å¿…é¡»æ˜¯ä¸²è¡Œçš„ï¼Œä½†æ˜¯å»ºè®®å°½é‡å…±ç”¨Connectionã€‚
9. Command:AMQPçš„å‘½ä»¤ï¼Œå®¢æˆ·ç«¯é€šè¿‡Commandå®Œæˆä¸AMQPæœåŠ¡å™¨çš„äº¤äº’æ¥å®ç°è‡ªèº«çš„é€»è¾‘ã€‚ä¾‹å¦‚åœ¨RabbitMQä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡publishå‘½ä»¤å‘é€æ¶ˆæ¯ï¼ŒtxSelectå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒtxCommitæäº¤ä¸€ä¸ªäº‹åŠ¡ã€‚

### ç‰¹æ€§

[çœ‹çœ‹](https://www.cnblogs.com/woms/p/7040882.html)

### ä½¿ç”¨åœºæ™¯

**åœºæ™¯1ï¼šå•å‘é€å•æ¥æ”¶**

ä½¿ç”¨åœºæ™¯ï¼šç®€å•çš„å‘é€ä¸æ¥æ”¶ï¼Œæ²¡æœ‰ç‰¹åˆ«çš„å¤„ç†ã€‚

**åœºæ™¯2ï¼šå•å‘é€å¤šæ¥æ”¶**

ä½¿ç”¨åœºæ™¯ï¼šä¸€ä¸ªå‘é€ç«¯ï¼Œå¤šä¸ªæ¥æ”¶ç«¯ï¼Œå¦‚åˆ†å¸ƒå¼çš„ä»»åŠ¡æ´¾å‘ã€‚ä¸ºäº†ä¿è¯æ¶ˆæ¯å‘é€çš„å¯é æ€§ï¼Œä¸ä¸¢å¤±æ¶ˆæ¯ï¼Œä½¿æ¶ˆæ¯æŒä¹…åŒ–äº†ã€‚åŒæ—¶ä¸ºäº†é˜²æ­¢æ¥æ”¶ç«¯åœ¨å¤„ç†æ¶ˆæ¯æ—¶downæ‰ï¼Œåªæœ‰åœ¨æ¶ˆæ¯å¤„ç†å®Œæˆåæ‰å‘é€ackæ¶ˆæ¯ã€‚

**åœºæ™¯3ï¼šPublish/Subscribe**

ä½¿ç”¨åœºæ™¯ï¼šå‘å¸ƒã€è®¢é˜…æ¨¡å¼ï¼Œå‘é€ç«¯å‘é€å¹¿æ’­æ¶ˆæ¯ï¼Œå¤šä¸ªæ¥æ”¶ç«¯æ¥æ”¶ã€‚

*å‘é€ç«¯ï¼š*
å‘é€æ¶ˆæ¯åˆ°ä¸€ä¸ªåä¸ºâ€œlogsâ€çš„exchangeä¸Šï¼Œä½¿ç”¨â€œfanoutâ€æ–¹å¼å‘é€ï¼Œå³å¹¿æ’­æ¶ˆæ¯ï¼Œä¸éœ€è¦ä½¿ç”¨queueï¼Œå‘é€ç«¯ä¸éœ€è¦å…³å¿ƒè°æ¥æ”¶ã€‚

*æ¥æ”¶ç«¯ï¼š*

1ã€å£°æ˜åä¸ºâ€œlogsâ€çš„exchangeçš„ï¼Œæ–¹å¼ä¸º"fanout"ï¼Œå’Œå‘é€ç«¯ä¸€æ ·ã€‚

2ã€channel.queueDeclare().getQueue();è¯¥è¯­å¥å¾—åˆ°ä¸€ä¸ª`éšæœºåç§°çš„Queue`ï¼Œè¯¥queueçš„ç±»å‹ä¸ºnon-durableã€exclusiveã€auto-deleteçš„ï¼Œå°†è¯¥queueç»‘å®šåˆ°ä¸Šé¢çš„exchangeä¸Šæ¥æ”¶æ¶ˆæ¯ã€‚

3ã€æ³¨æ„binding queueçš„æ—¶å€™ï¼Œchannel.queueBind()çš„`ç¬¬ä¸‰ä¸ªå‚æ•°Routing keyä¸ºç©ºï¼Œå³æ‰€æœ‰çš„æ¶ˆæ¯éƒ½æ¥æ”¶`ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸ä¸ºç©ºï¼Œåœ¨exchange typeä¸ºâ€œfanoutâ€æ–¹å¼ä¸‹è¯¥å€¼è¢«å¿½ç•¥ï¼

**åœºæ™¯4ï¼šRouting (æŒ‰è·¯çº¿å‘é€æ¥æ”¶)**Type=direct

```Type
*.orange.*, *.*.rabbit, lazy.*
```

ä½¿ç”¨åœºæ™¯ï¼šå‘é€ç«¯æŒ‰routing keyå‘é€æ¶ˆæ¯ï¼Œä¸åŒçš„æ¥æ”¶ç«¯æŒ‰ä¸åŒçš„routing keyæ¥æ”¶æ¶ˆæ¯ã€‚

*å‘é€ç«¯å’Œåœºæ™¯3çš„åŒºåˆ«ï¼š*

1ã€exchangeçš„typeä¸ºdirect
2ã€å‘é€æ¶ˆæ¯çš„æ—¶å€™åŠ å…¥äº†routing key

*æ¥æ”¶ç«¯å’Œåœºæ™¯3çš„åŒºåˆ«ï¼š*

åœ¨ç»‘å®šqueueå’Œexchangeçš„æ—¶å€™ä½¿ç”¨äº†routing keyï¼Œå³ä»è¯¥exchangeä¸Šåªæ¥æ”¶routing keyæŒ‡å®šçš„æ¶ˆæ¯ã€‚

**åœºæ™¯5ï¼šTopics (æŒ‰topicå‘é€æ¥æ”¶)**Type=topic

ä½¿ç”¨åœºæ™¯ï¼šå‘é€ç«¯ä¸åªæŒ‰å›ºå®šçš„routing keyå‘é€æ¶ˆæ¯ï¼Œè€Œæ˜¯æŒ‰å­—ç¬¦ä¸²â€œåŒ¹é…â€å‘é€ï¼Œæ¥æ”¶ç«¯åŒæ ·å¦‚æ­¤ã€‚

*å‘é€ç«¯å’Œåœºæ™¯4çš„åŒºåˆ«ï¼š*

1ã€exchangeçš„typeä¸ºtopic
2ã€å‘é€æ¶ˆæ¯çš„routing keyä¸æ˜¯å›ºå®šçš„å•è¯ï¼Œè€Œæ˜¯åŒ¹é…å­—ç¬¦ä¸²ï¼Œå¦‚"*.lu.#"ï¼Œ*åŒ¹é…ä¸€ä¸ªå•è¯ï¼Œ#åŒ¹é…0ä¸ªæˆ–å¤šä¸ªå•è¯ã€‚

*æ¥æ”¶ç«¯å’Œåœºæ™¯4çš„åŒºåˆ«ï¼š*

1ã€exchangeçš„typeä¸ºtopic
2ã€æ¥æ”¶æ¶ˆæ¯çš„routing keyä¸æ˜¯å›ºå®šçš„å•è¯ï¼Œè€Œæ˜¯åŒ¹é…å­—ç¬¦ä¸²ã€‚


### é˜Ÿåˆ—ã€ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…

åœ¨RabbitMQä¸­ï¼Œæœ‰ä¸€äº›åŸºæœ¬æœ¯è¯­ï¼š

* ç”Ÿäº§è€…ï¼šå°±æ˜¯å‘é€ä¿¡æ¯è¿™æ–¹ã€‚

* ä»»åŠ¡é˜Ÿåˆ—ï¼šè™½ç„¶ä¿¡æ¯æµåœ¨RabbitMQå’Œä½ çš„åº”ç”¨ä¹‹é—´æµåŠ¨ï¼Œå®ƒå¯ä»¥å­˜å‚¨åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚é˜Ÿåˆ—ä¸å—ä»»ä½•é™åˆ¶çš„çº¦æŸï¼Œå®ƒå¯ä»¥å­˜å‚¨ä»»æ„å¤šçš„æ¶ˆæ¯ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ— é™çš„ç¼“å†²åŒºã€‚è®¸å¤šç”Ÿäº§è€…å¯ä»¥å°†æ¶ˆæ¯å‘å¾€åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œè®¸å¤šæ¶ˆè´¹è€…å¯ä»¥å°è¯•ä»è¿™ä¸ªé˜Ÿåˆ—ä¸­æ¥å—æ•°æ®ã€‚

* æ¶ˆè´¹è€…ï¼šæ¶ˆè´¹è€…å’Œä¿¡æ¯æ¥å—è€…æœ‰ç›¸è¿‘çš„å«ä¹‰ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…å°±æ˜¯ä¸€ä¸ªç­‰å¾…å»æ¥å—ä¿¡æ¯çš„ç¨‹åºã€‚

* [ä½¿ç”¨RabbitMQ ä¸€](https://blog.csdn.net/m48o8gewuc/article/details/72871606)

### Exchangeã€Binding

### Exchange Typeã€Binding keyã€routing key

Exchange Typeï¼š
1. fanout æŠŠæ‰€æœ‰å‘é€åˆ°è¯¥ Exchange çš„æ¶ˆæ¯æŠ•é€’åˆ°æ‰€æœ‰ä¸ä»–ç»‘å®šçš„é˜Ÿåˆ—ä¸­ -- ã€å¹¿æ’­ã€‘
  * å®ƒé‡‡å–å¹¿æ’­æ¨¡å¼ï¼Œæ¶ˆæ¯è¿›æ¥æ—¶ï¼Œå°†ä¼šè¢«æŠ•é€’åˆ°ä¸æ”¹äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸­ã€‚
  * å¯¹äºFanoutç±»å‹çš„exchangeï¼Œä¼šå¿½ç•¥binding keyã€‚

2. direct æŠŠæ¶ˆæ¯æŠ•é€’åˆ°é‚£äº› binding key ä¸ routing key å®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—ä¸­ -- ã€å®šåˆ¶ã€‘
  * å®Œå…¨æ ¹æ®keyè¿›è¡ŒæŠ•é€’ã€‚ä¾‹å¦‚ï¼Œç»‘å®šæ—¶è®¾ç½®äº†routing keyä¸ºabcï¼Œå®¢æˆ·ç«¯æäº¤ä¿¡æ¯æäº¤ä¿¡æ¯æ—¶åªæœ‰è®¾ç½®äº†keyä¸ºabcçš„æ‰ä¼šæŠ•é€’åˆ°é˜Ÿåˆ—ï¼›

3. topic  å°†æ¶ˆæ¯è·¯ç”±åˆ° binding key ä¸ routing key æ¨¡å¼åŒ¹é…çš„é˜Ÿåˆ—ä¸­ -- ã€æ­£åˆ™åŒ¹é…ã€‘
  * åœ¨keyè¿›è¡Œæ¨¡å¼åŒ¹é…åè¿›è¡ŒæŠ•é€’ã€‚ä¾‹å¦‚ï¼šç¬¦å·â€#â€åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ï¼Œç¬¦å·â€*â€åŒ¹é…ä¸€ä¸²è¿ç»­çš„å­—æ¯å­—ç¬¦ï¼Œä¾‹å¦‚â€abc.#â€å¯ä»¥åŒ¹é…â€abc.def.ghiâ€ï¼Œè€Œâ€abc.*â€åªå¯ä»¥åŒ¹é…â€abc.defâ€ã€‚

4. headers ç”¨çš„æ¯”è¾ƒå°‘

![RabbitMQçš„ç»“æ„å›¾](https://img-blog.csdn.net/20170828204522460?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZHJlYW1jaGFzZXJpbmc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

### Topicç±»å‹çš„exchangeâ—â—â—

Topicç±»å‹çš„exchangeæ˜¯å¾ˆå¼ºå¤§çš„ï¼Œä¹Ÿå¯ä»¥å®ç°å…¶å®ƒç±»å‹çš„exchangeã€‚

* å½“ä¸€ä¸ªé˜Ÿåˆ—è¢«ç»‘å®šä¸ºbinding keyä¸ºâ€#â€æ—¶ï¼Œå®ƒå°†ä¼šæ¥æ”¶æ‰€æœ‰çš„æ¶ˆæ¯ï¼Œæ­¤æ—¶å’Œfanoutç±»å‹çš„exchangeå¾ˆåƒã€‚
* å½“binding keyä¸åŒ…å«â€*â€å’Œâ€#â€æ—¶ï¼Œè¿™æ—¶å€™å°±å¾ˆåƒdirectç±»å‹çš„exchangeã€‚

### ç”³æ˜é˜Ÿåˆ—ğŸ””ğŸ””ğŸ””

> assertQueue(queue?: string, options?: Options.AssertQueue, callback?: (err: any, ok: Replies.AssertQueue) => void): void;

é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—ä»¥åŠå­˜æ”¾åœ¨é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯ï¼Œéƒ½æ˜¯`éæŒä¹…åŒ–çš„`ã€‚ä¹Ÿå°±æ˜¯è¯´å½“rabbitMQå®•æ‰äº†æˆ–è€…æ—¶é‡å¯äº†ï¼Œåˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—ä»¥åŠæ¶ˆæ¯éƒ½ä¸ä¼šä¿å­˜

â“â“â“â“â“â“ ä¸æ˜¯ç†è§£
å°†é˜Ÿåˆ—è®¾ç½®ä¸ºæŒä¹…åŒ–åï¼Œè¿˜éœ€è¦å°†å‘é€çš„æ¶ˆæ¯ä¹Ÿè¦è®¾ç½®ä¸ºæŒä¹…åŒ–æ‰èƒ½ä¿è¯é˜Ÿåˆ—å’Œæ¶ˆæ¯ä¸€ç›´å­˜åœ¨

â“å¦‚æœé˜Ÿåˆ—è®¾ç½®ä¸ºæŒä¹…åŒ–ï¼Œæ¶ˆæ¯ä¸è®¾ç½®ä¸ºæŒä¹…åŒ–ï¼Œä¼šæ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„æƒ…å†µâ“
ğŸ•µï¸â€â€â€â€â€â€â€â€ğŸ•µï¸â€ğŸ•µï¸â€â™‚ï¸
å¯èƒ½æˆ‘ä»…ä»…åªæ˜¯æµ‹è¯•äº†ï¼Œæ–­å¼€è¿æ¥çš„æƒ…å†µï¼Œæ²¡æœ‰æµ‹è¯•åˆ°æœåŠ¡å™¨å®•æœºçš„è¿™ç§æƒ…å†µ
æ‰€ä»¥ï¼Œæ¶ˆæ¯æ˜¯å¦è¿˜åœ¨æœåŠ¡å™¨å®•æœºçš„æƒ…å†µä¸‹ä¿ç•™äº†è¿™ä¸€ç‚¹ï¼Œæ²¡æœ‰ç¡®è®¤ï¼Œä½†æ˜¯
çš„ç¡®æ—¶ç¡®è®¤äº†ï¼Œæ¶ˆæ¯æ²¡æœ‰è®¾ç½®æŒä¹…åŒ–ï¼Œæ–­å¼€è¿æ¥åé‡æ–°è¿æ¥ï¼Œè¿˜æ˜¯èƒ½å¤Ÿæ¥æ”¶åˆ°ä¹‹å‰çš„æ¶ˆæ¯

[çœ‹ä¸€äº›è¿™ä¸€ç¯‡æ–‡ç« ](https://www.cnblogs.com/Keep-Ambition/p/8044752.html)

```js
//          1ã€é˜Ÿåˆ—å       2ã€å¯é€‰å‚æ•°é…ç½®                 3ã€å›æ‰å‡½æ•°  ç¬¬ä¸€ä¸ªä¸ºé”™è¯¯   2ã€ç¬¬äºŒä¸ªä¸ºokï¼Œå€¼ä¸ºå®šä¹‰çš„é˜Ÿåˆ—ã€‚å…·ä½“æ˜¯ä¸€ä¸ªé˜Ÿåˆ—          
assertQueue(queue?: string, options?: Options.AssertQueue, callback?: (err: any, ok: Replies.AssertQueue) => void): void;
```

åŒæ ·è¿˜æœ‰åˆ é™¤é˜Ÿåˆ—çš„æ“ä½œğŸ†‘ğŸ†‘
**deleteQueue(queue: string, options?: Options.DeleteQueue, callback?: (err: any, ok: Replies.DeleteQueue) => void): void;**

```js
ch.assertQueue(q, {durable: true})

// æˆ–è€…
ch.assertQueue('', {exclusive: false}, (err, q) => {})
```

queueï¼šqueueçš„åç§°

exclusiveï¼šæ’ä»–é˜Ÿåˆ—ï¼Œå¦‚æœä¸€ä¸ªé˜Ÿåˆ—è¢«å£°æ˜ä¸ºæ’ä»–é˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ä»…å¯¹é¦–æ¬¡ç”³æ˜å®ƒçš„è¿æ¥å¯è§ï¼Œå¹¶åœ¨è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨åˆ é™¤ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸‰ç‚¹ï¼š1. æ’ä»–é˜Ÿåˆ—æ˜¯åŸºäºè¿æ¥å¯è§çš„ï¼ŒåŒä¸€è¿æ¥çš„ä¸åŒä¿¡é“æ˜¯å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€è¿æ¥åˆ›å»ºçš„æ’ä»–é˜Ÿåˆ—ï¼›2.â€œé¦–æ¬¡â€ï¼Œå¦‚æœä¸€ä¸ªè¿æ¥å·²ç»å£°æ˜äº†ä¸€ä¸ªæ’ä»–é˜Ÿåˆ—ï¼Œå…¶ä»–è¿æ¥æ˜¯ä¸å…è®¸å»ºç«‹åŒåçš„æ’ä»–é˜Ÿåˆ—çš„ï¼Œè¿™ä¸ªä¸æ™®é€šé˜Ÿåˆ—ä¸åŒï¼›3.å³ä½¿è¯¥é˜Ÿåˆ—æ˜¯æŒä¹…åŒ–çš„ï¼Œä¸€æ—¦è¿æ¥å…³é—­æˆ–è€…å®¢æˆ·ç«¯é€€å‡ºï¼Œè¯¥æ’ä»–é˜Ÿåˆ—éƒ½ä¼šè¢«è‡ªåŠ¨åˆ é™¤çš„ï¼Œè¿™ç§é˜Ÿåˆ—é€‚ç”¨äºä¸€ä¸ªå®¢æˆ·ç«¯å‘é€è¯»å–æ¶ˆæ¯çš„åº”ç”¨åœºæ™¯ã€‚

autoDeleteï¼šè‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—æ²¡æœ‰ä»»ä½•è®¢é˜…çš„æ¶ˆè´¹è€…çš„è¯ï¼Œè¯¥é˜Ÿåˆ—ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚è¿™ç§é˜Ÿåˆ—é€‚ç”¨äºä¸´æ—¶é˜Ÿåˆ—ã€‚

### ç”³æ˜äº¤æ¢å™¨

```js
//             1ã€è·¯ç”±äº¤æ¢å™¨åç§°      2ã€
assertExchange(exchange: string, type: string, options?: Options.AssertExchange, callback?: (err: any, ok: Replies.AssertExchange) => void): void;
```

```js
ch.assertExchange(ex, 'fanout', {durable: true})
```

### Exclusive Queue âŒâŒâŒâŒâŒâŒâŒâŒâŒâŒâŒâŒâŒâŒâŒâŒå¾ˆé‡è¦ã€‚å¿…é¡»è¦ç†è§£â­•â­•â­•â­•â­•â­•â­•â­•â­•â­•â­•â­•â­•

> æ’ä»–æ€§é˜Ÿåˆ—

è¯¥é˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯ï¼š

* åªå¯¹é¦–æ¬¡å£°æ˜å®ƒçš„è¿æ¥ï¼ˆConnectionï¼‰å¯è§
* ä¼šåœ¨å…¶è¿æ¥æ–­å¼€çš„æ—¶å€™è‡ªåŠ¨åˆ é™¤ã€‚â›”â›”â›”â›”â›”â›”â›”â›”â›”â›”â›”â›”

å¯¹äºç¬¬äºŒç‚¹ï¼ŒRabbitMQä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªé˜Ÿåˆ—ï¼Œè€Œä¸ç®¡è¿™ä¸ªé˜Ÿåˆ—æ˜¯å¦è¢«å£°æ˜æˆæŒä¹…æ€§çš„ï¼ˆDurable =true)ã€‚ ä¹Ÿå°±æ˜¯è¯´å³ä½¿å®¢æˆ·ç«¯ç¨‹åºå°†ä¸€ä¸ªæ’ä»–æ€§çš„é˜Ÿåˆ—å£°æ˜æˆäº†Durableçš„ï¼Œåªè¦è°ƒç”¨äº†è¿æ¥çš„Closeæ–¹æ³•æˆ–è€…å®¢æˆ·ç«¯ç¨‹åºé€€å‡ºäº†ï¼ŒRabbitMQéƒ½ä¼šåˆ é™¤è¿™ä¸ªé˜Ÿåˆ—ã€‚æ³¨æ„è¿™é‡Œæ˜¯è¿æ¥æ–­å¼€çš„æ—¶å€™ï¼Œè€Œä¸æ˜¯é€šé“æ–­å¼€ã€‚è¿™ä¸ªå…¶å®å‰ä¸€ç‚¹ä¿æŒä¸€è‡´ï¼ŒåªåŒºåˆ«è¿æ¥è€Œéé€šé“ã€‚

**å‚è€ƒ**
* [æ’ä»–æ€§é˜Ÿåˆ—]](https://www.cnblogs.com/rader/archive/2012/06/28/2567779.html)

### å‘é€æ¶ˆæ¯

```js
sendToQueue(queue: string, content: Buffer, options?: Options.Publish): boolean;

// ä½¿ç”¨äº¤æ¢å™¨çš„æ—¶å€™ ä½¿ç”¨è®¢é˜…å‘å¸ƒæ¨¡å¼
publish(exchange: string, routingKey: string, content: Buffer, options?: Options.Publish): boolean;
```


## å®é™…ä½¿ç”¨

### å®šä¹‰é˜Ÿåˆ—

> assertQueue

```js
ch.assertQueue(q, {durable: true})
```

1. queueï¼šè¿™æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œé˜Ÿåˆ—å
2. durableï¼šæ˜¯å¦æŒä¹…åŒ–.æŒä¹…åŒ–ï¼ŒæŒ‡çš„æ˜¯é˜Ÿåˆ—æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ã€‚åœ¨ä¹‹å‰çš„åšæ–‡ä¸­ä¹Ÿè¯´è¿‡ï¼Œå¦‚æœRabbitMQæœåŠ¡æŒ‚äº†æ€ä¹ˆåŠï¼Œé˜Ÿåˆ—ä¸¢å¤±äº†è‡ªç„¶æ˜¯ä¸å¸Œæœ›å‘ç”Ÿçš„ã€‚æŒä¹…åŒ–è®¾ç½®ä¸ºtrueçš„è¯ï¼Œå³ä½¿æœåŠ¡å´©æºƒä¹Ÿä¸ä¼šä¸¢å¤±é˜Ÿåˆ—
3. exclusiveï¼šæ˜¯å¦æ’å¤–. è®¾ç½®äº†æ’å¤–ä¸ºtrueçš„é˜Ÿåˆ—åªå¯ä»¥åœ¨æœ¬æ¬¡çš„è¿æ¥ä¸­è¢«è®¿é—®ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å½“å‰è¿æ¥åˆ›å»ºå¤šå°‘ä¸ªchannelè®¿é—®éƒ½æ²¡æœ‰å…³ç³»ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥æ¥è®¿é—®ï¼Œå¯¹ä¸èµ·ï¼Œä¸å¯ä»¥ï¼Œä¸‹é¢æ˜¯æˆ‘å°è¯•è®¿é—®äº†ä¸€ä¸ªæ’å¤–çš„queueæŠ¥çš„é”™ã€‚è¿˜æœ‰ä¸€ä¸ªéœ€è¦è¯´ä¸€ä¸‹çš„æ˜¯ï¼Œæ’å¤–çš„queueåœ¨å½“å‰è¿æ¥è¢«æ–­å¼€çš„æ—¶å€™ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼ˆæ¸…é™¤ï¼‰æ— è®ºæ˜¯å¦è®¾ç½®äº†æŒä¹…åŒ–
4. autoDeleteï¼šè¿™ä¸ªå°±å¾ˆç®€å•äº†ï¼Œæ˜¯å¦è‡ªåŠ¨åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯è¯´queueä¼šæ¸…ç†è‡ªå·±ã€‚ä½†æ˜¯æ˜¯åœ¨æœ€åä¸€ä¸ªconnectionæ–­å¼€çš„æ—¶å€™
5. argumentsï¼šè¿™ä¸ªå€¼å¾—æ‹¿å‡ºæ¥å•è®²ä¸€æ¬¡ï¼Œæš‚æ—¶ä¸è¯´

### æ¥æ”¶æ¶ˆæ¯

ä¸ºäº†å‘é€æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª`é˜Ÿåˆ—`ï¼Œæˆ‘ä»¬å¯ä»¥å°†`æ¶ˆæ¯` â¡å‘é€â¬…åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼š

```js
let q = 'task_queue3'
let msg = process.argv.slice(2).join(' ') || "Hello World!"
ch.assertQueue(q, {durable: true}) // RabbitMQä»»åŠ¡é˜Ÿåˆ— æŒä¹…åŒ–
ch.sendToQueue(q, new Buffer(msg), {persistent: true}) // å‘é€çš„æ¶ˆæ¯ä¹Ÿæ˜¯æŒä¹…åŒ–çš„
```

å»ºç«‹ä¸€ä¸ªæ¥å—è€…çš„æ–¹å¼å’Œå‘é€è€…æ˜¯ç›¸åŒçš„ã€‚æ‰“å¼€ä¸€ä¸ªè¿æ¥å’Œé€šé“ï¼Œå¹¶ä¸”ç”³æ˜ä¸€ä¸ªéœ€è¦å¤„ç†çš„é˜Ÿåˆ—ã€‚`æ³¨æ„ï¼šè¿™é‡Œçš„é˜Ÿåˆ—å’Œå‘é€è€…é‡Œé¢å®šä¹‰çš„é˜Ÿåˆ—éœ€è¦åŒ¹é…ã€‚`

```js
let q = 'task_queue3';

ch.assertQueue(q, {durable: true}); // æ¶ˆæ¯æŒä¹…åŒ–;å½“ä¸€ä¸ªRabbitMQæœåŠ¡é€€å‡ºæˆ–è€…ä¸­æ–­çš„æƒ…å†µä¸‹
```

è¿™é‡Œä¹Ÿå®šä¹‰é˜Ÿåˆ—çš„åŸå› ï¼šæ¥å—è€…å¯èƒ½æ¯”å‘é€è€…å…ˆå¼€å§‹æ‰§è¡Œã€‚æˆ‘ä»¬éœ€è¦ç¡®ä¿å½“æ¥å—è€…å¤„ç†queueçš„æ—¶å€™ï¼Œqueueæ˜¯å­˜åœ¨çš„ã€‚

ç”±äºæ¶ˆæ¯çš„å‘é€æ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªå›è°ƒï¼Œè¿™æ ·ï¼Œå½“RabbitMQå‘é€æ¶ˆæ¯ç»™æˆ‘ä»¬çš„æ¶ˆè´¹è€…æ—¶ï¼Œå›è°ƒä¼šæ‰§è¡Œã€‚è¿™ä¸ªä¹Ÿæ˜¯Channel.consumeåšçš„äº‹æƒ…ã€‚

```js
ch.consume(q, function(msg) {
      let secs = msg.content.toString().split('.').length - 1;
      console.log(" [x] Received %s", msg.content.toString());
      setTimeout(function() {
        console.log(" [x] Done");
        ch.ack(msg); // æ¶ˆæ¯ç¡®è®¤
      }, secs * 1000);
    }, {noAck: false});
```

**æ¶ˆæ¯å…¬å¹³åˆ†å‘**

å¦‚æœRabbitåªç®¡æŒ‰é¡ºåºæŠŠæ¶ˆæ¯å‘åˆ°å„ä¸ªæ¶ˆè´¹è€…èº«ä¸Šï¼Œä¸è€ƒè™‘æ¶ˆè´¹è€…è´Ÿè½½çš„è¯ï¼Œå¾ˆå¯èƒ½å‡ºç°ï¼Œä¸€ä¸ªæœºå™¨é…ç½®ä¸é«˜çš„æ¶ˆè´¹è€…é‚£é‡Œå †ç§¯äº†å¾ˆå¤šæ¶ˆæ¯å¤„ç†ä¸å®Œï¼ŒåŒæ—¶é…ç½®é«˜çš„æ¶ˆè´¹è€…å´ä¸€ç›´å¾ˆè½»æ¾ã€‚ä¸ºè§£å†³æ­¤é—®é¢˜ï¼Œå¯ä»¥åœ¨å„ä¸ªæ¶ˆè´¹è€…ç«¯ï¼Œé…ç½®perfetch=1,æ„æ€å°±æ˜¯å‘Šè¯‰RabbitMQåœ¨æˆ‘è¿™ä¸ªæ¶ˆè´¹è€…å½“å‰æ¶ˆæ¯è¿˜æ²¡å¤„ç†å®Œçš„æ—¶å€™å°±ä¸è¦å†ç»™æˆ‘å‘æ–°æ¶ˆæ¯äº†

### msg åŒ…å«çš„ä¿¡æ¯

```js
{ fields:
   { consumerTag: 'amq.ctag-0G90lW9Jx1IN1kAbuiVYaA',
     deliveryTag: 1,
     redelivered: false,
     exchange: 'ex_queue',â
     routingKey: '' },â --> éœ€è¦ä½¿ç”¨ assertExchange çš„æ—¶å€™æ‰æœ‰ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰çš„
  properties:
   { contentType: undefined,
     contentEncoding: undefined,
     headers: {},   â -->  éœ€è¦ä½¿ç”¨ headers çš„äº¤æ¢å™¨æ¨¡å¼æ‰è¡Œ
     deliveryMode: undefined,
     priority: undefined,
     correlationId: undefined,
     replyTo: undefined,
     expiration: undefined,
     messageId: undefined,
     timestamp: undefined,
     type: undefined,
     userId: undefined,
     appId: undefined,
     clusterId: undefined },
  content: <Buffer 68 65 6c 6c 6f 20 77 6f 72 6c 64 20 36> }
```

### bindQueue

> channel.queueBind(queueName, EXCHANGE_NAME, bindingKey)

```js
ch.bindQueue(q.queue, ex, severity)
```

queue é˜Ÿåˆ—åç§°
exchange äº¤æ¢å™¨åç§°
routingKey è·¯ç”±key
arguments å…¶å®ƒçš„ä¸€äº›å‚æ•°


### æ¶ˆæ¯ç¡®è®¤

å¤„ç†ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡éœ€è¦è€—è´¹å¾ˆé•¿æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ®µé‡Œé¢ï¼Œå¯èƒ½æˆ‘ä»¬çš„workerè¿›ç¨‹ç”±äºæŸç§åŸå› æŒ‚æ‰äº†ï¼Œè¿™ç§å¼‚å¸¸æƒ…å†µæ˜¯éœ€è¦è€ƒè™‘çš„ã€‚ä½†æ˜¯æˆ‘ä»¬ç°æœ‰çš„ä»£ç é‡Œé¢å¹¶æ²¡æœ‰åšè¿™ç§å¼‚å¸¸çš„å¤„ç†ï¼Œå½“RabbitMQå°†ä»»åŠ¡æ´¾å‘ç»™workerè¿›ç¨‹ä¹‹åï¼Œæˆ‘ä»¬ç«‹å³å°†è¿™ä¸ªä»»åŠ¡ä»å†…å­˜ä¸­å‰”é™¤æ‰äº†ï¼Œè®¾æƒ³ä¸‹ï¼Œå‡è®¾workeræ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œæˆ‘ä»¬é©¬ä¸Šå°†è¿›ç¨‹æ€æ­»æ‰ï¼Œè¿™ä¸ªæ—¶å€™ä»»åŠ¡å¹¶æ²¡æœ‰è¢«æˆåŠŸæ‰§è¡Œçš„ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šä¸¢å¤±æ‰€æœ‰æ´¾å‘åˆ°è¿™ä¸ªworkerè¿›ç¨‹ä½†æ˜¯è¿˜æ²¡æœ‰è¢«å¤„ç†çš„ä»»åŠ¡ä¿¡æ¯ã€‚


### æ¶ˆæ¯æŒä¹…åŒ–

1. æ¶ˆæ¯äº¤æ¢æœºï¼ˆexchangeï¼‰æŒä¹…åŒ–ï¼Œåœ¨å£°æ˜æ—¶æŒ‡å®šdurableä¸º
2. æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆqueueï¼‰æŒä¹…åŒ–ï¼Œåœ¨å£°æ˜æ—¶æŒ‡å®šdurableä¸º
3. æ¶ˆæ¯æŒä¹…åŒ–ï¼Œåœ¨æŠ•é€’æ—¶æŒ‡å®šdelivery_modeä¸º2ï¼ˆ1æ˜¯éæŒä¹…åŒ–

åˆšåˆšè°ˆåˆ°ï¼Œå¦‚æœä¸€ä¸ªworkerè¿›ç¨‹æŒ‚æ‰äº†ï¼Œä¸è®©æ¶ˆæ¯ä¸¢å¤±çš„åšæ³•ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ•´ä¸ªRabbitMQçš„æœåŠ¡å™¨æŒ‚æ‰äº†å‘¢ï¼Ÿå½“ä¸€ä¸ªRabbitMQæœåŠ¡é€€å‡ºæˆ–è€…ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šå¿˜è®°ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯é™¤éä½ å‘Šè¯‰å®ƒä¸è¦ä¸¢æ‰ï¼Œå³æˆ‘ä»¬é€šçŸ¥RabbitMQä»»åŠ¡é˜Ÿåˆ—å’Œè¿™äº›ä»»åŠ¡éƒ½æ˜¯éœ€è¦æŒä¹…åŒ–çš„ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿RabbitMQæ°¸è¿œä¸ä¼šä¸¢å¤±æ‰æˆ‘ä»¬çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚

```js
ch.assertQueue('hello', {durable: true});
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é…ç½®persistent é€‰é¡¹è®©æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ä¹Ÿæ˜¯æŒä¹…åŒ–çš„ã€‚

```js
ch.sendToQueue(q, new Buffer(msg), {persistent: true});
```

## å‚è€ƒ

* [1 åœ¨ node ä¸­ä½¿ç”¨ rabbitmq](https://blog.csdn.net/m48o8gewuc/article/details/72871598)
* [2 git tutorials](https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/javascript-nodejs/src/new_task.js)
* [ä¸­æ–‡æ–‡æ¡£](http://rabbitmq.mr-ping.com/description.html)
* [æ¶ˆæ¯é˜Ÿåˆ—å­¦ä¹ ä¹‹ä¸€](https://blog.csdn.net/anzhsoft/article/details/19563091)
* [RabbitMQ æ¶æ„è®¾è®¡](http://www.cnblogs.com/wukong-holmes/p/9306733.html)
* [åŸºç¡€æ–‡ç« ç³»åˆ—](http://www.cnblogs.com/leocook/p/mq_rabbitmq_0.html)
* [æ­£ç¡®ä½¿ç”¨rabbitmq -- æ§åˆ¶ç•Œé¢](https://stackoverflow.com/questions/33951516/cannot-enable-rabbitmq-management-plugin-on-windows)